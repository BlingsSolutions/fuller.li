<!DOCTYPE html>
<html lang="en">
<head>
  <title>Kyle Fuller</title>
  <meta charset="utf-8" />

  <link rel="stylesheet" href="https://f.fontdeck.com/s/css/YbEbVONS3yZB1DYf9YVHgZSgeMA/kylefuller.co.uk/14510.css" type="text/css" />
  <link rel="stylesheet" href="http://kylefuller.co.uk/theme/css/master.css" type="text/css" />
  <link rel="stylesheet" href="http://kylefuller.co.uk/theme/css/pygment.css" type="text/css" />

  <link href="http://kylefuller.co.uk/" type="application/atom+xml" rel="alternate" title="Kyle Fuller ATOM Feed" />

  
    <link href="http://kylefuller.co.uk/posts/feed/latest" type="application/atom+xml" rel="alternate" title="Kyle Fuller RSS Feed" />
  

  <link href="https://kylef.tent.is/" rel="https://tent.io/rels/profile" />
</head>

<body id="">
  <section>
    
  
    <article>
      <div class="date">Sun 16 December 2012</div>

      <h1><a href="http://kylefuller.co.uk/posts/how-does-browserid-work/" rel="bookmark" title="Permalink to How does BrowserID work?">How does BrowserID work?</a></h1>

      <div class="entry-content">
        <p>This article will explain how cryptography behind BrowserID works, and lightly
cover why BrowserID is a better alternative to OpenID.</p>
<p>A website will ask your browser for a BrowserID assertion via JavaScript.
This will either use a native BrowserID API in your browser, or it will use
the JavaScript implementation of BrowserID. This is known as the user agent.</p>
<div class="highlight"><pre><span class="nx">navigator</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">gotAssertion</span><span class="p">);</span>
</pre></div>
<p>For supporting browsers, the user agent will be supplied and the
<cite>navigator.id.get</cite> method will exist. The user agent can be provided by either
the browser, an extension to the browser, or via a JavaScript include on the
website to use a JavaScript implementation.</p>
<div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://browserid.org/include.js&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div>
<p>This means that a browser or browser extension can provide their own
implementation, or a JavaScript implementation can be used in unsupported
browsers.</p>
<p>Out of the process, once the browser has an assertion. It will provide the
assertion to the <cite>gotAssertion</cite> callback. The website can then provide this
back to the web server to validate the assertion to confirm the user's identity.</p>
<div class="section" id="what-is-an-assertion">
<h2>What is an assertion?</h2>
<p>An assertion is a string which holds a JSON structure including an identity
assertion and an identity certificate. The assertion will be generated by the
browser for an identity, the browser will need to get an identity certificate
from a provider to ensure they own that identity. This identity can be used
again and again until it expires.</p>
<div class="section" id="identity-certificate">
<h3>Identity certificate</h3>
<p>An identity certificate will look like the following:</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;iss&quot;</span><span class="o">:</span> <span class="s2">&quot;kylefuller.co.uk&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exp&quot;</span><span class="o">:</span> <span class="s2">&quot;1313971280961&quot;</span><span class="p">,</span>
    <span class="s2">&quot;public-key&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">},</span>
    <span class="s2">&quot;principal&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;email&quot;</span><span class="o">:</span> <span class="s2">&quot;inbox@kylefuller.co.uk&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The &quot;iss&quot; field will include the domain of the issuer. The code checking the
assertion should verify that is either the domain used in the email address, or
a trusted fallback provider, such as <cite>browserid.org</cite>. This means that either
the domain providing your email address or <cite>browserid.org</cite> can provide a valid
identity certificate for your email.</p>
<p>The fallback provider will allow you to use that provider instead of your email
provider in the situation that your email provider does not support BrowserID.</p>
<p>The above identity certificate signed by the issuer, and their certificate
should be available over HTTPS at <cite>https://iss/.well-known/browserid</cite>.</p>
<p>The public key in the identity certificate is the public key of the user. This
key can be generated by the browser so only the user will have control over it.</p>
</div>
<div class="section" id="identity-assertion">
<h3>Identity assertion</h3>
<p>The identity assertion is the final piece in a BrowserID assertion. It will be
signed by the browser's private key, so it will match the public key in the
identity certificate which our provider has confirmed we own.</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;exp&quot;</span><span class="o">:</span> <span class="mi">1320280579437</span><span class="p">,</span>
    <span class="s2">&quot;aud&quot;</span><span class="o">:</span> <span class="s2">&quot;https://demand-browserid.herokuapp.com&quot;</span>
<span class="p">}</span>
</pre></div>
<p>The identity assertion provides an expiry and an audience. The identity
assertion allows a website to confirm the assertion is meant for them, the
audience should be the website that we want to sign-in to.</p>
<p>The relying party which the user is identifying to should check both the
identity certificate and the identity assertion to check the certificates
match, and that neither has expired. If these are valid assertions for our
audience, then we can confirm the user owns the email address and in the
identity certificate.</p>
</div>
</div>
<div class="section" id="why-use-browserid-whats-wrong-with-openid">
<h2>Why use BrowserID, whats wrong with OpenID?</h2>
<p>There are many benefits of BrowserID over OpenID.</p>
<ul class="simple">
<li>BrowserID is far simpler to use than OpenID for an average user. It is also
quicker, since you do not need to type your OpenID into each site.</li>
<li>When you sign-in to a site using OpenID, your OpenID provider knows you are
visiting that site. With BrowserID, your BrowserID provider is not aware of
the site you are visiting since your assertion is created in the browser. You
have already retrieved your identity certificate from the provider. Your
privacy is protected with BrowserID.</li>
<li>BrowserID uses an email address, any existing site will already have your
email address. This would allow a site to start using BrowserID without
requiring you to provide any additional information.</li>
</ul>
</div>

      </div>
    </article>
  
    <article>
      <div class="date">Sun 16 December 2012</div>

      <h1><a href="http://kylefuller.co.uk/posts/organising-dotfiles-in-a-git-repository/" rel="bookmark" title="Permalink to Organising dotfiles in a git repository">Organising dotfiles in a git repository</a></h1>

      <div class="entry-content">
        <p>Organising dotfiles can be done in numerous ways. Many dotfile repositories
often have their own clunky script to copy or symbolically link their dotfiles
in place. I feel this is a dirty approach and I prefer my files to be easily
manageable via the git command. I don't want to have to copy a file every time
I change it.</p>
<img alt="/static/images/dotfiles.png" class="align-center" src="/static/images/dotfiles.png" style="width: 589px; height: 276px;" />
<p>Another approach I have seen done, is making your whole home directory a git
repository. Unfortunately after using this solution you will come across a
number of flaws, any repository in your home directory will now follow your
<cite>~/.gitignore</cite>. I also came into many problems when I was using Xcode which
will try to git add projects into your dotfiles repository. Like symbolic
linking all my dotfiles into place, this solution also felt clunky.</p>
<p>Git allows you to seperate the work tree and the git dir via environment
variables or arguments to the git command. This allows us to store the bare git
dir in <cite>~/.files.git</cite> while still keeping our entire home directory as the work
tree for git.</p>
<p>I settled for using a simple alias in my <cite>.zshrc</cite> which allows me to easily use
git to manage my dotfiles. But, it is imporant to remember that the home
directory will not be seen as a git repository unless you use this alias. You
won't be able to accidentally use git commands thinking you were in another
repo, (or accidentally git add a bunch of things in a mercurial repository).</p>
<p>Here is the alias I use:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">alias </span><span class="nv">home</span><span class="o">=</span>git --work-tree<span class="o">=</span><span class="nv">$HOME</span> --git-dir<span class="o">=</span><span class="nv">$HOME</span>/.files.git
</pre></div>
<p>You can use this alias just as you would use the normal git command, this
allows you to clone and init a repo. To clone a dotfiles repo, you can do:</p>
<div class="highlight"><pre><span class="nv">$ </span>home clone git://github.com/kylef/dotfiles.git
</pre></div>

      </div>
    </article>
  
    <article>
      <div class="date">Sun 18 March 2012</div>

      <h1><a href="http://kylefuller.co.uk/posts/website-20/" rel="bookmark" title="Permalink to Website 2.0">Website 2.0</a></h1>

      <div class="entry-content">
        <p>It's taken me nearly a year to finish my new website. I have gone through many
iterations and have finally stuck with this theme and system.</p>
<p>Instead of running my own custom Django blog, this site is now powered by
<a class="reference external" href="http://pelican.notmyidea.org/">Pelican</a>, a static site generator. I have
created numerous patches for Pelican so that it works with custom URL
structures, so none of my URL's break when I migrated to Pelican.</p>
<div class="section" id="but-this-isn-t-your-second-revision-of-the-site">
<h2>But this isn't your second revision of the site?</h2>
<p>Ok you got me, this isn't really my second version of this site. I don't know
how many revisions I have gone through, but this is the second revision to have
the same content and posts. It's my second major release of the site in a
version control system. I use a git repository for the current site which can
be found on github <a class="reference external" href="https://github.com/kylef/kylefuller.co.uk">here</a>.</p>
</div>
<div class="section" id="what-is-new">
<h2>What is new?</h2>
<p>The theme for the website is completely different, I have made a new <a class="reference external" href="/about/">about
page</a>. I have lost all the comments from my old site, there was far
too much spam to port them over.</p>
<img alt="/static/images/website-20.png" src="/static/images/website-20.png" />
</div>

      </div>
    </article>
  
    <article>
      <div class="date">Sat 13 August 2011</div>

      <h1><a href="http://kylefuller.co.uk/posts/monitoring-inspircd-mrtg/" rel="bookmark" title="Permalink to Monitoring InspIRCd with MRTG">Monitoring InspIRCd with MRTG</a></h1>

      <div class="entry-content">
        <p>This guide will show you how to configure MRTG to show statistics from an
InspIRCd IRC server, this will include user counts and channel counts. This
guide assumes you already have InspIRCd and MRTG setup and working. You can see
an example of this working at <a href="http://hydra.sector5d.org/">Sector 5D</a>.</p>
<h3>InspIRCd config</h3>
<p>First, you will need to configure InspIRCd to use the <code>m_http</code> and
<code>m_http_stats</code> module. I configure InspIRCd to listen on localhost and port
8081 with SSL, but you could pick any port you want, just remember to change
the <code>$address</code> variable inside <code>inspircd-stats.sh</code> later.</p>
<p>Note, the following config is for InspIRCd 2.0, if you use a older version you
may need to change the bind line to a http line, please see the InspIRCd wiki
for using a older version.</p>
<div class="codehilite"><pre><span class="nt">&lt;module</span> <span class="na">name=</span><span class="s">&quot;m_httpd.so&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;module</span> <span class="na">name=</span><span class="s">&quot;m_httpd_stats.so&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;bind</span> <span class="na">address=</span><span class="s">&quot;localhost&quot;</span> <span class="na">port=</span><span class="s">&quot;8081&quot;</span> <span class="na">type=</span><span class="s">&quot;httpd&quot;</span> <span class="na">ssl=</span><span class="s">&quot;gnutls&quot;</span><span class="nt">&gt;</span>
</pre></div>


<p>Once you have placed this in your InspIRCd config, you can rehash or reload
InspIRCd and then you will be able to connect to it over http(s) to retrive
stats. Such as at https://localhost:8081/stats</p>
<h4>Creating a script to gather the user or channel count on InspIRCd</h4>
<p>The following script queries the InspIRCd <code>m_httpd_stats</code> module for the user
or channel count. This depends on <a href="http://xmlstar.sourceforge.net/">XMLStarlet</a>
(<a href="http://packages.debian.org/search?keywords=xmlstarlet">Debian package</a>, <a href="https://aur.archlinux.org/packages.php?ID=20101">Arch
AUR Package</a>), so please
install this first.</p>
<div class="codehilite"><pre><span class="c">#!/bin/sh</span>

<span class="nv">address</span><span class="o">=</span><span class="s2">&quot;https://localhost:8081/stats&quot;</span>
<span class="nv">count_type</span><span class="o">=</span><span class="nv">$1</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$count_type&quot;</span> !<span class="o">=</span> <span class="s2">&quot;user&quot;</span>  <span class="o">&amp;&amp;</span> <span class="s2">&quot;$count_type&quot;</span> !<span class="o">=</span> <span class="s2">&quot;channel&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nb">echo</span> <span class="s2">&quot;Usage: $0 &lt;user|channel&gt;&quot;</span>
  <span class="nb">exit </span>1
<span class="k">elif</span>

<span class="nv">count</span><span class="o">=</span><span class="k">$(</span>wget -q -Y off -O - --no-check-certificate <span class="nv">$address</span> | xml sel -t -v <span class="s2">&quot;inspircdstats/general/${count_type}count&quot;</span><span class="k">)</span>

<span class="nb">echo</span> <span class="nv">$count</span>
<span class="nb">echo</span> <span class="nv">$count</span>
<span class="nb">echo</span> <span class="s2">&quot;IRC $count_type&quot;</span>
</pre></div>


<p>This script will need to be available from the user which you run MRTG as. I
have placed mine in <code>/usr/local/bin/inspircd-stats.sh</code> but you could place it
somewhere like <code>$HOME/bin/inspircd-stats.sh</code>.</p>
<p>To download and install this to /usr/local/bin run the following:</p>
<div class="codehilite"><pre>sudo mkdir -p /usr/local/bin
sudo wget https://raw.github.com/gist/1042604/b19a4cfd91b6956063d962c977f3d5f8e3318d7d/inspircd-stats.sh -O /usr/local/bin/inspircd-stats.sh
sudo chmod+x /usr/local/bin/inspircd-stats.sh
</pre></div>


<p>Now you have this <code>inspircd-stats.sh</code> script, you can use it to get the user
and channel count as follows:</p>
<div class="codehilite"><pre>/usr/local/bin/inspircd-stats.sh user
/usr/local/bin/inspircd-stats.sh channel
</pre></div>


<h3>MRTG Config</h3>
<p>You will need to add the following to your mrtg config file, this could be
located at <code>/etc/mrtg.cfg</code>, but this depends on how you setup mrtg.</p>
<div class="codehilite"><pre><span class="c"># For IRC Users:</span>
<span class="n">Target</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> `<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">inspircd</span><span class="o">-</span><span class="n">stats</span><span class="p">.</span><span class="n">sh</span> <span class="n">user</span>`
<span class="n">Title</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> <span class="n">IRC</span> <span class="n">Users</span>
<span class="n">PageTop</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">IRC</span> <span class="n">Users</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="n">MaxBytes</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> 10000000000
<span class="n">ShortLegend</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> <span class="n">users</span>
<span class="n">YLegend</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> <span class="n">Users</span>
<span class="n">LegendI</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> <span class="n">Users</span>
<span class="n">LegendO</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span>
<span class="n">Legend1</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> <span class="n">Users</span>
<span class="n">Legend2</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span>
<span class="n">Options</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">users</span><span class="p">]:</span> <span class="n">growright</span><span class="p">,</span><span class="n">nopercent</span><span class="p">,</span><span class="n">gauge</span>

<span class="c"># For IRC Channels:</span>
<span class="n">Target</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> `<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">inspircd</span><span class="o">-</span><span class="n">stats</span><span class="p">.</span><span class="n">sh</span> <span class="n">channel</span>`
<span class="n">Title</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> <span class="n">IRC</span> <span class="n">Channels</span>
<span class="n">PageTop</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">IRC</span> <span class="n">Channels</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="n">MaxBytes</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> 10000000000
<span class="n">ShortLegend</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> <span class="n">channels</span>
<span class="n">YLegend</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> <span class="n">Channels</span>
<span class="n">LegendI</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> <span class="n">Channels</span>
<span class="n">LegendO</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span>
<span class="n">Legend1</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> <span class="n">Channels</span>
<span class="n">Legend2</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span>
<span class="n">Options</span><span class="p">[</span><span class="n">irc</span><span class="p">.</span><span class="n">channels</span><span class="p">]:</span> <span class="n">growright</span><span class="p">,</span><span class="n">nopercent</span><span class="p">,</span><span class="n">gauge</span>
</pre></div>


<p>Now, you can run your MRTG command for your config or wait for the MRTG cron
and it should show up your InspIRCd stats.</p>
      </div>
    </article>
  
    <article>
      <div class="date">Wed 01 July 2009</div>

      <h1><a href="http://kylefuller.co.uk/posts/pre-populating-data-admin-panel/" rel="bookmark" title="Permalink to Pre-populating data in the admin panel">Pre-populating data in the admin panel</a></h1>

      <div class="entry-content">
        <p>I have always found it awkward working with sites and user's in django admin panel. James Bennet from <a href="http://www.b-list.org/weblog/2008/dec/24/admin/">b-list.org</a> explained his way of doing it on his blog, but I found his way a bit limiting, I still want superusers to be able to change the author of a post.</p>
<p>After looking around in the source code for <code>ModelAdmin</code> I found two method's, one of which was not documented. These were <code>formfield_for_manytomany</code> and <code>formfield_for_foreignkey</code>. These methods allow us to supply our own FormField, which could have initial data. These methods also get passed the <code>HttpRequest</code>, which contains the user. So we can fill in author of a blog post and the current site.</p>
<p>In this post I will quickly show you how to use this method to fill in current data based upon the request inside the admin.</p>
<h3>My model</h3>
<p>Here is a model from which the rest of the article will work from.</p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.models</span> <span class="kn">import</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>

<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Site</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
</pre></div>


<p>As you can see, the author is a ForeignKey field, and sites is a ManyToMany field. The methods we use to set the default reflects this. We use <code>formfield_for_foreignkey</code> to set the default user.</p>
<h3>Here is my ModelAdmin class</h3>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">PostAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">fieldsets</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">,)</span>
    <span class="p">}),</span>
    <span class="p">(</span><span class="s">&#39;Advanced options&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;classes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;collapse&#39;</span><span class="p">,),</span>
        <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;author&#39;</span><span class="p">,</span> <span class="s">&#39;sites&#39;</span><span class="p">,)</span>
    <span class="p">})</span>
<span class="p">)</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">PostAdmin</span><span class="p">)</span>
</pre></div>


<h3>Selecting the current site</h3>
<p>To select the current site, what we will do is create a method called <code>formfield_for_manytomany</code> inside our <code>PostAdmin</code> class. This method will be called each time the admin panel goes to draw a <code>ManyToMany</code> field in a Post. So all we do is set the initial value to the current site. But it is important to remember that the field may be something else, so it is important to check if it is the sites field.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">formfield_for_manytomany</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">db_field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;sites&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">db_field</span><span class="o">.</span><span class="n">formfield</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_manytomany</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>


<h3>Selecting the current user</h3>
<p>This is very similar to selecting the current site, instead we create a method called <code>formfield_for_foreignkey</code> for ForeignKey's instead of <code>ManyToMany</code> fields.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">formfield_for_foreignkey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">db_field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;author&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">db_field</span><span class="o">.</span><span class="n">formfield</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">formfield_for_foreignkey</span><span class="p">(</span><span class="n">db_field</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>


<p>Now that we have selected the current user, it would be nice to only let superusers use this field, but I couldn't find a way to only show this for certain users. So instead we will just disallow normal user's from saving the post as another user.</p>
<p>I dont think it is possible to optionally hide the author field from a user, so what I have done was to disallow a non superuser from editing the post's author.</p>
<h4>Disallowing a user from changing another post</h4>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">has_change_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">has_class_permission</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">PostAdmin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">has_change_permission</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_class_permission</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>


<p>This snippet was not written by myself, but by James Bennet from <a href="http://www.b-list.org/weblog/2008/dec/24/admin/">b-list.org</a>.</p>
<h3>Only let the user view their own posts</h3>
<p>Another measure to limit the possibilities of the user can be to let the user only view their own posts. To do this we just change the queryset to filter posts where the author is themselves. We still want superusers to see all posts, so only filter it for normal users.</p>
<div class="codehilite"><pre><span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>


<p>To see a complete example of this you can view the source code for <a href="https://github.com/kylef/lithium">lithium</a>.</p>
      </div>
    </article>
  

  <div class="pagination">
    

    
      <a class="next" href="http://kylefuller.co.uk/index2.html"><span class="arrow"></span>Older &raquo;</a>
    
  </div>

  </section>

  <aside id="sidebar">
    <h1>Kyle Fuller</h1>

    <p>I’m <span>Kyle Fuller</span> and I’m a programmer residing in England. You can find me as <span><a href="http://twitter.com/kylefuller">@kylefuller</a></span> on Twitter, or <span><a href="https://github.com/kylef">@kylef</a></span> on Github.</p>


    <h4>Some projects I am involved with include:</h4>
    <ul>
      
        <li><a href="http://znc.in/">ZNC</a> — An IRC bouncer with modules & scripts support.</li>
      
        <li><a href="http://textualapp.com/">Textual</a> — Textual is a lightweight IRC client created specifically for Mac OS X.</li>
      
        <li><a href="https://github.com/kylef/zokket">zokket</a> — An asynchronous socket networking library for python</li>
      
        <li><a href="http://readthedocs.org/docs/pyppp/en/latest/">PyPPP</a> — A python implementation of Perfect Paper Passwords a single-use passcode system for multifactor authentication.</li>
      
        <li><a href="http://readthedocs.org/docs/lithium/en/latest/">lithium</a> — A set of applications for writing a Django website's, it includes a blog, a wiki, and many other useful applications.</li>
      
        <li><a href="https://github.com/kylef/rivr">rivr</a> — A python micro web-framework</li>
      
    </ul>

    <h4>Recent Articles</h4>
    <ul>
      
        
          <li>
            <a href="http://kylefuller.co.uk/posts/hello-welcome/" rel="bookmark"title="Permalink to Hello, and welcome">Hello, and welcome</a>
          </li>
        
      
        
          <li>
            <a href="http://kylefuller.co.uk/posts/how-install-irssi-dreamhost/" rel="bookmark"title="Permalink to How to install irssi on Dreamhost">How to install irssi on Dreamhost</a>
          </li>
        
      
        
          <li>
            <a href="http://kylefuller.co.uk/posts/pre-populating-data-admin-panel/" rel="bookmark"title="Permalink to Pre-populating data in the admin panel">Pre-populating data in the admin panel</a>
          </li>
        
      
        
          <li>
            <a href="http://kylefuller.co.uk/posts/monitoring-inspircd-mrtg/" rel="bookmark"title="Permalink to Monitoring InspIRCd with MRTG">Monitoring InspIRCd with MRTG</a>
          </li>
        
      
        
          <li>
            <a href="http://kylefuller.co.uk/posts/website-20/" rel="bookmark"title="Permalink to Website 2.0">Website 2.0</a>
          </li>
        
      
        
          <li>
            <a href="http://kylefuller.co.uk/posts/organising-dotfiles-in-a-git-repository/" rel="bookmark"title="Permalink to Organising dotfiles in a git repository">Organising dotfiles in a git repository</a>
          </li>
        
      
    </ul>
  </aside>




</body>
</html>